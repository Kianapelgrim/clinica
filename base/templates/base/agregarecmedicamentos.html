{% extends 'main.html' %}

{% block content %}

{% load static %}

                <!-- Begin Page Content -->
                <div class="container-fluid">

                    <!-- Page Heading -->
                    <h2>Gestión de estado de compra de Medicamentos</h2>
                    <div class="card">
                        <div class="card-body">
                            <form action="/registrarecmedicamentos/" method="POST" id="ecmedicamentosForm">
                                {% csrf_token %}
                                <div class="form-group">
                                    <input type="text" id="txtNombre" name="txtNombre" class="form-control" placeholder="Nombre" minlength="2" maxlength="50" required>
                                    <small id="nombreError" class="text-danger"></small>
                                </div>
                           
                                <div class="form-group">
                                    <button type="submit" class="btn btn-success btn-block text-white">Guardar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <script>
                        // Get form element
                        var form = document.getElementById('ecmedicamentosForm');
                    
                        form.addEventListener('submit', function(event) {
                            event.preventDefault(); // Prevent form submission to check nombre uniqueness first
                    
                            var nombreInput = document.getElementById('txtNombre');
                            var nombreError = document.getElementById('nombreError');
                    
                            // Basic validation first
                            if (!/^[a-zA-Z\s]*$/.test(nombreInput.value)) {
                                nombreError.textContent = 'Nombre no puede contener números ni caracteres especiales';
                                return;
                            } else if (!/^(?!\s*$).+/.test(nombreInput.value)) {
                                nombreError.textContent = 'Nombre no puede estar vacío';
                                return;
                            } else {
                                nombreError.textContent = ''; // Clear any previous error message
                            }
                    
                            // Check for nombre uniqueness
                            checkNombreUniqueness(nombreInput.value)
                                .then(isUnique => {
                                    if (isUnique) {
                                        // Nombre is unique; proceed with form submission
                                        form.submit();
                                    } else {
                                        // Nombre is not unique; prevent submission and show error
                                        nombreError.textContent = 'Nombre debe ser único';
                                    }
                                })
                                .catch(error => {
                                    nombreError.textContent = 'Nombre debe ser único';
                                    console.error('Error checking nombre uniqueness:', error);
                                    // Handle error (possibly show a generic error message)
                                });
                        });
                    
                        function checkNombreUniqueness(nombre) {
                            return new Promise((resolve, reject) => {
                                var xhr = new XMLHttpRequest();
                                xhr.open('GET', '/path/to/your/endpoint?nombre=' + encodeURIComponent(nombre), true);
                                xhr.onload = function() {
                                    if (this.status >= 200 && this.status < 300) {
                                        var response = JSON.parse(xhr.responseText);
                                        resolve(response.isUnique); // Assuming the endpoint returns a JSON object with an isUnique boolean property
                                    } else {
                                        reject({
                                            status: this.status,
                                            statusText: xhr.statusText
                                        });
                                    }
                                };
                                xhr.onerror = function() {
                                    reject({
                                        status: this.status,
                                        statusText: xhr.statusText
                                    });
                                };
                                xhr.send();
                            });
                        }
                    </script>
                    
                    
                   
            <!-- End of Main Content -->

                     
        
                </div>
                <!-- End of Content Wrapper -->
        
            </div>
            <!-- End of Page Wrapper -->
        
            <!-- Scroll to Top Button-->
            <a class="scroll-to-top rounded" href="#page-top">
                <i class="fas fa-angle-up"></i>
            </a>
        
            <!-- Logout Modal-->
            <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                            <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                        </div>
                        <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                            <a class="btn btn-primary" href="login.html">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
            {% endblock %}
            <!-- Bootstrap core JavaScript-->
            <script src="{%static 'vendor/jquery/jquery.min.js'%}"></script>
            <script src="{%static 'vendor/bootstrap/js/bootstrap.bundle.min.js'%}"></script>
        
            <!-- Core plugin JavaScript-->
            <script src="{%static 'vendor/jquery-easing/jquery.easing.min.js'%}"></script>
        
            <!-- Custom scripts for all pages-->
            <script src="{%static 'js/sb-admin-2.min.js'%}"></script>
        
            <!-- Page level plugins -->
            <script src="{%static 'vendor/chart.js/Chart.min.js'%}"></script>
        
            <!-- Page level custom scripts -->
            <script src="{%static 'js/demo/chart-area-demo.js'%}"></script>
            <script src="{%static 'js/demo/chart-pie-demo.js'%}"></script>
        
        </body>
        
        </html>